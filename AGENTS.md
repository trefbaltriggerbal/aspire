# Agent Instructions

- Run `dotnet build AspireDemo.sln` after modifying code or docs. If `dotnet` is
  not available, note the failure in the Testing section.
- Install the .NET 8 SDK with `apt-get update` and `apt-get install -y dotnet-sdk-8.0` if `dotnet` is missing.
- Use concise commit messages and describe your changes in the PR summary.
- Always include a Testing section in PRs summarizing any commands run.
- Ensure the solution builds successfully before creating a PR.
- If test projects are present, run `dotnet test` and confirm all tests pass.
- Each PR must provide evidence of running `dotnet build AspireDemo.sln`.
- Only open a PR after all tests pass when test projects are present.
- Keep this repository focused on a minimal sample demonstrating .NET Aspire.
- Ensure it contains:
  - A Blazor project for hands-on testing.
  - Two console projects that communicate with each other in any manner you choose.
  - A tutorial explaining how Aspire works.
- Create GitHub issues to track work on:
  - Console logs
  - Structured logs
  - Traces
  - Metrics
  so that these resources can be viewed when running the console projects.


## UI-tests met Playwright (BlazorAppUiTest)

### Eenmalige setup (Lokaal of CI-agent)

```bash
# .NET 8 SDK moet al aanwezig zijn (zie eerdere sectie)
dotnet tool install --global Microsoft.Playwright.CLI   # voegt 'playwright' CLI toe
playwright install --with-deps                          # download Chromium/FF/WebKit
````

### Test-project aanmaken

```bash
cd aspire                               # repo-root
dotnet new console -n BlazorAppUiTest
cd BlazorAppUiTest
dotnet add package Microsoft.Playwright
cd ..                                   # terug naar root
dotnet sln AspireDemo.sln add BlazorAppUiTest/BlazorAppUiTest.csproj
```

> **Tip voor CI/build-agents**
> Voeg in **BlazorAppUiTest.csproj** dit MSBuild-target toe zodat browsers
> automatisch worden gedownload wanneer `dotnet build` draait:
>
> ```xml
> <Target Name="PlaywrightInstall" AfterTargets="Build">
>   <Exec Command="playwright install --with-deps" />
> </Target>
> ```

### Lokaal ontwikkelen / debuggen

```bash
# Blazor-app starten (aparte shell)
dotnet run --project BlazorApp > /tmp/blazor.log 2>&1 &

# UI-test draaien (headless)
dotnet run --project BlazorAppUiTest

# Visueel meekijken?
#  – pas in Program.cs aan →  Headless = false
#  – voer de test opnieuw uit, Chromium-venster opent
```

### Verwachte console-output

```
Before: Current count: 0 | After: Current count: 1
Counter incremented
```

🔧 Met deze stappen kan elke agent (of CI-runner) de Playwright-tests herhalen en garanderen dat de headless UI-controle van **BlazorApp** altijd werkt.

## 📌 Playwright & Testing Guidelines for AGENTS

To avoid confusion and broken CI builds, follow these rules when working with Playwright tests:

### 🔁 Temporary Code Changes

- ❌ **Do not hardcode or permanently change URLs or configuration values** in the test code just to get tests working. You can only edit the flows.json file to alter the tests itself


---

### 🧪 Headless vs Headed Mode

- ✅ On CI (Ubuntu), tests must run in **headless** mode (`Headless = true`)
- ✅ On Windows (for local debugging), it's allowed to run **headed** (`Headless = false`)

This code is used for that logic

```csharp
bool isWindows = RuntimeInformation.IsOSPlatform(OSPlatform.Windows);

await using var browser = await playwright.Chromium.LaunchAsync(new()
{
    Headless = !isWindows
});
```
### 🐧 When to use `xvfb-run` (Linux-only)

If you're running tests on a **Linux machine with no graphical environment (e.g., CI)** and you **want to run headed mode for debugging**, you'll need to simulate a display using [`xvfb-run`](https://linux.die.net/man/1/xvfb-run).

**Why?**  
Without a virtual display, headed browsers will crash with errors like `TargetClosedException` or `ERR_CONNECTION_REFUSED`.

**How to use:**

```bash
# Run headed tests in a virtual X display (Linux only)
xvfb-run dotnet test --project BlazorAppUiTest
```

> ⚠️ You still need to set `Headless = false` in your code for this to be effective.

---

### 📂 Which Files Should Be Committed?

|File type|Commit?|Notes|
|---|---|---|
|`*.png` screenshots|❌|Auto-generated by tests — do **not** commit|
|HTML/Markdown Playwright logs|✅|Useful for debugging — **OK to commit**|
|`FileToGiveBackToUser.md`|❌|This file is generated by the test — skip it|
|Other generated `.md` files|✅|Allowed unless explicitly excluded|

---

### 🌐 URLs & Port Configuration

- ✅ The Blazor demo app typically runs on port `5228`.  
    You can extract this from the logs, but for now it's safe to assume it's stable.
    
- Avoid hardcoding the port if possible. Instead, consider parsing it from the app’s console output:
    

```csharp
// Tip: Parse stdout from the app process to extract the actual port
// Or default to: http://localhost:5228 if stable
```
